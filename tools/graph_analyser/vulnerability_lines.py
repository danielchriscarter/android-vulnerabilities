#!/usr/bin/env python3

# Copyright (C) Daniel Carter 2019
# Licensed under the 2-clause BSD licence

# Plots a line per discovered Android vulnerability

import os
import json
from datetime import datetime, date

import matplotlib.pyplot as plt

VULNERABILITY_PATH = '../../input/vulnerabilities/'
# List of keys to try, in order, to find the vulnerability discovery date
KEYS = ['Discovered_on', 'Fixed_on', 'Fix_released_on', 'Reported_on']
dates = []

for filename in os.listdir(VULNERABILITY_PATH):
    # Only include non-template JSON files
    if filename == 'template.json':
        continue
    if not filename.endswith('.json'):
        continue
    with open(VULNERABILITY_PATH + filename, 'r') as f:
        vulnerability = json.load(f)
        for key in KEYS:
            # Ignore if it's not in the expected format
            if isinstance(vulnerability[key], list) and len(vulnerability[key]) != 0:
                inner = vulnerability[key][0]
                if isinstance(inner, list) and len(inner) != 0:
                    sdate = inner[0]
                    dates.append(datetime.strptime(sdate, '%Y-%m-%d').date())
                    break

# Set graph font size
plt.rc('font', size=20)

# Plot vertical lines on graph
for date in dates:
    #print(date, ':', dates.count(date))
    plt.axvline(x=date)

plt.title('Android Vulnerability Discovery Dates')
plt.xlabel('Date')
# Hide y-axis labels
plt.yticks([])
plt.show()
